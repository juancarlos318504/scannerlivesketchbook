let o=[],E=(e,s)=>{let r=[],t={get(){return t.lc||t.listen(()=>{})(),t.value},l:0,lc:0,listen(a,l){return t.lc=r.push(a,l||t.l)/2,()=>{let d=r.indexOf(a);~d&&(r.splice(d,2),--t.lc)}},notify(a,l){let d=!o.length;for(let n=0;n<r.length;n+=2)o.push(r[n],r[n+1],t.value,a,l);if(d){for(let n=0;n<o.length;n+=5){let g;for(let i=n+1;!g&&(i+=5)<o.length;)o[i]<o[n+1]&&(g=o.push(o[n],o[n+1],o[n+2],o[n+3],o[n+4]));g||o[n](o[n+2],o[n+3],o[n+4])}o.length=0}},off(){},set(a){let l=t.value;l!==a&&(t.value=a,t.notify(l))},subscribe(a,l){let d=t.listen(a,l);return a(t.value),d},value:e};return t};const w=E("camera"),X=E(""),W=document.querySelector("#camera-container");(!1 in navigator||!1 in navigator.mediaDevices)&&alert("Lo sentimos, el acceso a la c치mara no est치 disponible en tu navegador");const m=document.querySelector("#video"),L=document.querySelector("#btnPlay"),F=document.querySelector("#btnPause"),ee=document.querySelector("#btnScreenshot"),te=document.querySelector("#btnChangeCamera"),h=document.querySelector("#canvas");document.querySelector("#devicesSelect");const G={video:{width:{min:1280,ideal:1920,max:2560},height:{min:720,ideal:1080,max:1440}}};let k=!0,b;L.addEventListener("click",function(){m.play(),L.classList.add("hidden"),F.classList.remove("hidden")});F.addEventListener("click",function(){m.pause(),F.classList.add("hidden"),L.classList.remove("hidden")});ee.addEventListener("click",function(){h.width=m.videoWidth,h.height=m.videoHeight,h.getContext("2d").drawImage(m,0,0),w.set("screenshot"),X.set(h.toDataURL("image/png"))});te.addEventListener("click",function(){k=!k,J()});function $(){b&&b.getTracks().forEach(e=>{e.stop()})}async function J(){$(),G.video.facingMode=k?"user":"environment";try{b=await navigator.mediaDevices.getUserMedia(G),m.srcObject=b}catch{alert("Could not access the camera")}}w.subscribe(e=>{e=="camera"?(W.classList.remove("hidden"),J()):(W.classList.add("hidden"),$())});const ne=(e,s)=>JSON.stringify({eventName:e,payload:s});Y();function Y(){const e=new WebSocket("https://servidor-node-js.onrender.com");e.onopen=function(s){oe(s);const r=ne("unity-message",{mensaje:"Mensaje desde el cliente"});e.send(r)},e.onclose=function(s){ce(s)},e.onmessage=function(s){ae(s)},e.onerror=function(s){se(s)}}function oe(e){console.log("Conexi칩n con websockets establecida",e)}function ce(e){console.log("Conexi칩n con websockets perdida",e),setTimeout(function(){Y()},2e3)}function ae(e){console.log("Mensaje websockets",e)}function se(e){console.log("ERROR: "+e.data)}const re=document.querySelector("#btnSend"),p=document.querySelector("#screenshot-container");re.addEventListener("click",function(){let e=cv.imread(p);cv.cvtColor(e,e,cv.COLOR_RGBA2RGB,0);let s=new cv.Mat,r=new cv.Dictionary(cv.DICT_6X6_250),t=new cv.Mat,a=new cv.MatVector,l=new cv.Mat,d=new cv.Mat,n=cv.matFromArray(3,3,cv.CV_64F,[966.3557171609066,0,206.79307818305685,0,966.3557171609066,293.70020600555273,0,0,1]),g=cv.matFromArray(5,1,cv.CV_64F,[-.0015007354215536557,.9872238982580184,.01718845254240881,-.02680595882042461,-2.3313928379240205]);cv.detectMarkers(e,r,a,t);let i=[];if(console.log(t.rows),t.rows!=4){alert("Por favor aseg[urate que los 4 marcadores negros del dibujo asparezcan en la foto");return}if(t.rows>0)for(let u=0;u<t.rows;++u){let c=a.get(u),f=0,V=0;for(let y=0;y<4;++y){let z=c.data32F.subarray(y*2,y*2+2);f+=z[0],V+=z[1]}let B=f/4,U=V/4;i=[...i,{id:t.intPtr(0,u)[0],center:{x:B,y:U},corners:[{x:c.data32F[0],y:c.data32F[1]},{x:c.data32F[2],y:c.data32F[3]},{x:c.data32F[4],y:c.data32F[5]},{x:c.data32F[6],y:c.data32F[7]}]}],cv.circle(e,new cv.Point(B,U),5,new cv.Scalar(255,0,0,255),-1)}i.sort((u,c)=>u.id-c.id),console.log(i);const M=i[0].corners[1],q=i[1].corners[0],R=i[2].corners[2],O=i[3].corners[3];let T=cv.imread(p);const S=p.width,C=p.height;let _=new cv.Mat,Z=new cv.Size(S,C),A=cv.matFromArray(4,1,cv.CV_32FC2,[M.x,M.y,q.x,q.y,R.x,R.y,O.x,O.y]),D=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,S,0,0,C,S,C]),P=cv.getPerspectiveTransform(A,D);cv.warpPerspective(T,_,P,Z,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar),cv.imshow("canvas",_),document.getElementById("downloadLink");let I=document.getElementById("canvas");I.toDataURL("image/jpg");let N=null;I.toBlob(async function(u){N=new File([u],"test.jpg",{type:"image/jpeg"});const c=new FormData;c.append("file",N),c.append("boat",i[0].id);const f=await fetch("https://servidor-node-js.onrender.com/api/draws",{method:"POST",body:c});console.log(await f.json())},"image/jpeg"),T.delete(),_.delete(),P.delete(),A.delete(),D.delete(),e.delete(),s.delete(),r.delete(),t.delete(),a.delete(),l.delete(),d.delete(),n.delete(),g.delete()});const H=document.querySelector("#preview-container"),ie=document.querySelector("#screenshot-container"),le=document.querySelector("#btnRepeat");document.querySelector("#btnSend");le.addEventListener("click",()=>{w.set("camera")});w.subscribe(e=>{console.log(e),e=="screenshot"?H.classList.remove("hidden"):H.classList.add("hidden")});X.subscribe(e=>{ie.setAttribute("src",e)});const j=E(!1);j.subscribe(e=>{});const K="libs/opencv_ganwenyao.js";let v=document.createElement("script");v.setAttribute("async","");v.setAttribute("type","text/javascript");v.addEventListener("load",()=>{j.set(!0)});v.addEventListener("error",()=>{console.log("Failed to load "+K)});v.src=K;let Q=document.getElementsByTagName("script")[0];Q.parentNode.insertBefore(v,Q);const x=document.querySelector("#modal_full_screen_loader");x.showModal();j.subscribe(e=>{e?setTimeout(()=>{x.close()},2e3):x.showModal()});
